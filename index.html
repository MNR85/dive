<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/user.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Dive usage examples</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Dive usage examples</h1>
          <h2>Starting processes in various ways like "<a href="http://www.dest-unreach.org/socat/">socat</a>" using sockets in various ways.</h2>
        </header>

        <section id="downloads" class="clearfix">
        <div>
          <a href="https://github.com/vi/dive/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/vi/dive/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/vi/dive" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </div>
        <p>Download pre-built x86 and ARMel dive and dived <a href="#prebuiltbinaries">here</a></p>
        </section>

        <hr>

        <section id="main_content">
          <p>See basic information about dive in the <a href="https://github.com/vi/dive#readme">readme file</a>.</p>
         

<h1><strong>Examples</strong></h1>

<h2>Simple remote process startup in unshare</h3>

<pre><code># # Start dived in unshared network namespace
# unshare -n  -- dived /var/run/qqq.socket -d
# dive /var/run/qqq.socket ip addr
1218: lo: &lt;LOOPBACK&gt; mtu 16436 qdisc noop state DOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
# dive /var/run/qqq.socket bash
# # Now we are inside that unshare
# ip link set lo up
# exit
exit
# # outside unshare again
# dive /var/run/qqq.socket bash
# ip addr
1218: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
# # our network configuration persisted
</code></pre>

<p>Use <code>dived socket --unshare net</code> instead of <code>unshare -n dived socket</code> on kernels around v2.6.32.</p>

<h2>Network turn off switch</h2>

<p>Let users start programs with network access disabled.</p>

<pre><code># umask 0000
# unshare -n -- dived /var/run/qqq2.socket -d

$ dive /var/run/qqq2.socket bash
$ ping 127.0.0.1
connect: Network is unreachable
$ id
$ uid=1000(vi) gid=1000(vi) groups=1000(vi),20(dialout),21(fax),...
</code></pre>

<h2>"Poor man's sudo" example 1</h2>

<p>Grant Alice access to Bob.</p>

<pre><code>root# dived /var/run/alice2bob -d -C 700 -U alice:alice -u bob

alice$ HOME=/home/bob USER=bob dive /var/run/alice2bob bash
bob$ id
uid=1037(bob) gid=1045(bob) groups=1045(bob),1033(ololo)
bob$ exit
alice$
malice$ dive /var/run/alice2bob bash
connect: Permission denied
</code></pre>

<h2>Poor man's suid-bit-less sudo example 2</h2>

<p>Allow certain users execute certain programs (script in some directory) as root. Use client's command line arguments and filehandles, but not environment variables, current directory or controlling tty.</p>

<pre><code>root# dived  /var/run/suidless_sudo --detach --user root --no-csctty --chmod 777 --no-environment  --no-chdir --no-umask -- /root/scripts/suidless_sudo
root# cat /root/scripts/suidless_sudo
#!/usr/bin/perl -w
  use strict;
  die("No script specified") if $#ARGV == -1;
  my $script = $ARGV[0];
  my $user = $ENV{"DIVE_USER"};
  die ("No user") unless $user;
  die ("Forbidden") unless $user eq "alice";
  die ("Bad script name $script") unless ($script =~ /^([a-zA-Z0-9_]{1,64})$/);
  exec "/root/scripts/allowed_scripts/$1"

alice$ dive /var/run/suidless_sudo ../../../bin/bash
Bad script name  at /root/scripts/suidless_sudo line 8.
alice$ dive /var/run/suidless_sudo reboot
Reboot started

bob$ dive /var/run/suidless_sudo reboot
Forbidden at /root/scripts/suidless_sudo line 7.
bob$ DIVE_USER=alice dive /var/run/suidless_sudo reboot
Forbidden at /root/scripts/suidless_sudo line 7.
</code></pre>

<h2> Ping without suidbit example 1</h2>

<p>Allow users access to ping (but not to <code>ping -f</code>) without suidbit:</p>

<pre><code>root# cp /bin/ping /root/ping # loses suidbit
root# dived  /var/run/pinger --detach --effective-user root --chmod 777 --no-environment  --no-chdir  -- /root/ping

alice$ dive /var/run/pinger 127.0.0.1
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.163 ms
64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.108 ms
^C
--- 127.0.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 0.108/0.135/0.163/0.029 ms
dive: Something failed with the server

alice$ dive /var/run/pinger -f 127.0.0.1
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
ping: cannot flood; minimal interval, allowed for user, is 200ms
</code></pre>


<h2> Ping without suidbit example 2</h2>

<p>Like previous one, but with minimal necessary capabilities for ping:</p>

<pre><code>root# cp /bin/ping /root/ping
root# setcap =ei /root/ping
root# dived  /var/run/pinger --detach  --chmod 777 \
         --no-environment  --no-chdir \
         --no-new-privs --set-capabilities cap_net_raw+ip -B cap_net_raw \
         -- /root/ping
</code></pre>

<h2>Authentication example</h2>

<p>dived supports starting external programs for authentication. 
The program is started when file descriptors are already received from client, but
environtment, controlling terminal (if any), root and current directories, user and
umask are still original. Nonzero exit code from authentication program rejects the client.</p>

<pre><code>root# dived @boblogin --detach --user bob --authenticate 'user=bob /root/askpassword' -- bash

alice$ HOME=/home/bob dive @boblogin
  bob's Password: 
bob$ exit
alice$ dive @boblogin
  bob's Password: 
  Go away! (('Authentication failure', 7))
  dive: Something failed with the server
alice$ 
</code></pre>

<p>"@boblogin" is abstract UNIX socket. "askpassword" program is included in source repository (uses python-pam).</p>



<h2>"Just run" example</h2>

<p>There are many options in dived that affect what happens before the program begin execve'd. --just-run option allow use them without messing with UNIX sockets.</p>

<p>In this mode dived works as poor man's:
<ul>
<li><strong>su</strong> : --user and/or --effective-user options</li>
<li><strong>chroot</strong> : --chroot option</li>
<li><strong><a href="http://libslack.org/daemon/">daemon</a></strong> : --children-daemon option</li>
<li><strong><a href="http://man.devl.cz/man/8/capsh">capsh</a></strong> : --retain-capabilities/--remove-capabilities and --set-capabilities</li>
<li><a href="http://linux.die.net/man/2/unshare">unshare</a> : --unshare option</li>
</ul>
</p>

<h4>Remove ability to start suid-bit things</h4>

<pre><code>root# dived -J -S -T -X -- bash
root# su -l alice
alice$ ping 127.0.0.1
ping: icmp open socket: Operation not permitted
</code></pre>

<h4>Starting ping from user "nobody" with only cap_net_raw</h4>

<pre><code>root# setcap =ei /root/ping
root# dived -J -S -T -u nobody -X -c "= cap_net_raw+ip" -- /root/ping 127.0.0.1</code></pre>

<h4>Starting another "init"</h4>

<pre><code>
# usldived -J -S -T -P --unshare pid,fs -- /bin/bash
# mount -t proc proc /proc
bash: child setpgid (8275 to 8275): No such process

# ps aux
bash: child setpgid (8369 to 8369): No such process
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  0.0   4628  1904 pts/13   S    04:48   0:00 /bin/bash
root         5  0.0  0.0   4184  1100 pts/13   R+   04:48   0:00 ps aux
# exit
# </code></pre>


<h2>inetd setup</h2>

<p>dived can be called from inetd instead of opening the socket itself.</p>

<pre><code>root# cat >> /etc/inetd.conf << EOF
/var/run/nobody.dive    stream unix nowait nobody /usr/bin/dived dived -i -P
/var/run/shutdown.dive  stream unix nowait root /usr/bin/dived dived  -i -e root -T -E -A -H -O -M -- /sbin/shutdown -h now
EOF
root# /etc/init.d/openbsd-inetd reload
</code></pre>

<p> and everybody who can acess <code>/var/run/*.dive</code> can shutdown the system (but not cancel the shutdown) or execute any commands from "nobody" user.</p>

<h1> Pre-built binaries </h1>
<a name="prebuiltbinaries"/>
<table>
<tr class="bl"><td>14K</td><td class="la"><a href="http://vi-server.org/pub/dive">Download pre-built x86 dive</a></td></tr>
<tr class="bl"><td>26K</td><td class="la"><a href="http://vi-server.org/pub/dived">Download pre-built x86 dived</a></td></tr>
<tr class="bl"><td>34K</td><td class="la"><a href="http://vi-server.org/pub/dive_musl">Download pre-built x86 static dive</a></td></tr>
<tr class="bl"><td>64K</td><td class="la"><a href="http://vi-server.org/pub/dived_musl">Download pre-built x86 static dived</a> (no capabilities support)</td></tr>
<tr class="bl"><td>25K</td><td class="la"><a href="http://vi-server.org/pub/dive_1.2.0-1_i386.deb">Download pre-built x86 Debian package</a></td></tr>
<tr class="bl"><td>33K</td><td class="la"><a href="http://vi-server.org/pub/dive_armel">Download pre-built ARMel static dive</a></td></tr>
<tr class="bl"><td>48K</td><td class="la"><a href="http://vi-server.org/pub/dived_armel">Download pre-built ARMel static dived</a> (no capabilities support)</td></tr>
</table>

        <footer>
          <p>See the feature list, usage and notes are in the <a href="https://github.com/vi/dive#readme">readme file</a>.</p>
          Dive is maintained by <a href="https://github.com/vi">_Vi</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>        
      </div>
    </div>
  </body>
</html>